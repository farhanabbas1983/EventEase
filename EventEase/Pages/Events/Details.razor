@page "/events/{id:guid}"

@inject EventEase.Services.EventService EventService
@inject NavigationManager Navigation

@using EventEase.Models

<PageTitle>Event Details</PageTitle>

@inject EventEase.Services.ToastService ToastService

@if (ev is null)
{
    <h3>Event not found</h3>
    <p>The requested event could not be found.</p>
}
else
{
    <h1>@ev.Name</h1>
    <EventCard EventName="@ev.Name" Date="@ev.Date" Location="@ev.Location" />

    <ConfirmModal @ref="confirmModal" />

    <div class="mt-3">
        <NavLink class="btn btn-primary me-2" href="@($"/events/{ev.Id}/register")">Register</NavLink>
        <NavLink class="btn btn-outline-secondary me-2" href="@($"/events/{ev.Id}/edit")">Edit</NavLink>
        <button class="btn btn-danger" @onclick="ConfirmDelete">Delete</button>
        <NavLink class="btn btn-link ms-2" href="/events">Back to events</NavLink>
    </div>

    <h4 class="mt-4">Registrations (@ev.Registrations.Count) — Present: @ev.Registrations.Count(r => r.Attended)</h4>
    @if (ev.Registrations.Any())
    {
        <ul>
            @foreach (var r in ev.Registrations)
            {
                <li @key="r.Id">
                    <strong>@r.Name</strong> (@r.Email) — @r.RegisteredAt.ToLocalTime().ToString("g")
                    @if (r.Attended)
                    {
                        <span class="badge bg-success ms-2">Present</span>
                        <button class="btn btn-sm btn-link text-warning ms-2" @onclick="() => ToggleAttendance(r.Id, false)">Mark absent</button>
                    }
                    else
                    {
                        <button class="btn btn-sm btn-outline-success ms-2" @onclick="() => ToggleAttendance(r.Id, true)">Mark present</button>
                    }
                    <button class="btn btn-sm btn-link text-danger ms-2" @onclick="() => RemoveRegistration(r.Id)">Remove</button>
                </li>
            }
        </ul>
    }
    else
    {
        <p>No registrations yet.</p>
    }
}

@code {
    [Parameter]
    public Guid id { get; set; }

    private Event? ev;
    private EventEase.Components.ConfirmModal? confirmModal;

    protected override void OnParametersSet()
    {
        ev = EventService.GetById(id);
    }

    private async Task ConfirmDelete()
    {
        if (ev == null || confirmModal == null) return;
        var ok = await confirmModal.ShowAsync("Delete event", $"Delete event '{ev.Name}'? This action cannot be undone.");
        if (ok)
        {
            EventService.DeleteEvent(ev.Id);
            ToastService.ShowSuccess("Event deleted");
            Navigation.NavigateTo("/events");
        }
    }

    private void RemoveRegistration(Guid registrationId)
    {
        if (ev == null) return;
        EventService.RemoveRegistration(ev.Id, registrationId);
        ToastService.ShowInfo("Registration removed");
        // refresh
        ev = EventService.GetById(id);
        StateHasChanged();
    }

    private void ToggleAttendance(Guid registrationId, bool attended)
    {
        if (ev == null) return;
        EventService.SetAttendance(ev.Id, registrationId, attended);
        ToastService.ShowInfo(attended ? "Marked present" : "Marked absent");
        ev = EventService.GetById(id);
        StateHasChanged();
    }
}
